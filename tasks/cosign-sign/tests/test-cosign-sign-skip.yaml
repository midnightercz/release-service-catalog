---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-cosign-sign
spec:
  description: |
    Test signing skip when signature already exists
  workspaces:
    - name: tests-workspace
  tasks:
    - name: prepare
      workspaces:
        - name: data
          workspace: tests-workspace
      params: []
      taskSpec:
        params: []
        steps:
          - image: quay.io/konflux-ci/release-service-utils:38c3bfd7479c86b832cba5b61f9bbde40c469393
            script: |
              #!/usr/bin/env bash
              set -eux
              touch "$(workspaces.data.path)/cosign_calls.txt"
    - name: run-task
      taskRef:
        name: cosign-sign
      params:
        - name: pipeline_image
          value: "quay.io/redhat-isv/operator-pipelines-images:released"
        - name: digest
          value: "sha256:0000"
        - name: identity
          value: "registry.stage.redhat.io/myproduct/myrepo:abc"
        - name: reference
          value: "quay.io/redhat-pending/myproduct----myrepo:abc"
        - name: signaturesFound
          value: "1"
        - name: secretName
          value: "test-cosign-sign-secret"
      workspaces:
        - name: data
          workspace: tests-workspace
      runAfter:
        - prepare
    - name: check-results
      workspaces:
        - name: data
          workspace: tests-workspace
      params: []
      taskSpec:
        params: []
        steps:
          - image: quay.io/konflux-ci/release-service-utils:38c3bfd7479c86b832cba5b61f9bbde40c469393
            script: |
              #!/usr/bin/env bash
              set -eux
              cosign_call=$(cat "$(workspaces.data.path)/cosign_calls.txt")
              if [ "$cosign_call" != "" ]; then
                exit 1
              fi
      runAfter:
        - run-task
